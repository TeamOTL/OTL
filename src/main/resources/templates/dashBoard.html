<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content=""/>
    <meta name="author" content=""/>

    <title>ÎåÄÏãúÎ≥¥Îìú</title>

    <!-- Custom fonts for this template-->
    <link
            th:href="@{vendor/fontawesome-free/css/all.min.css}"
            rel="stylesheet"
            type="text/css"
    />
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous"
    />

    <!-- Custom styles for this template -->
    <link th:href="@{css/sb-admin-2.min.css}" rel="stylesheet"/>


    <script th:src="@{js/index.global.js}"></script>
</head>
<style>
    #todolistContainer {
        right: -100%;
        z-index: 1;
        transition: right 0.5s ease-in;
    }

    #todolistContainer.show {
        right: 5%;
        transition: right 0.5s ease-out;
    }
</style>
<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">
    <custom-sidebar></custom-sidebar>

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
            <!-- TopBar -->
            <custom-topbar
                    th:attr="data-nickname=${nickname}, data-profile-image=${memberProfileImage}"></custom-topbar>
            <!-- TopBar End -->
            <!-- container fluid -->
            <div class="container-fluid">
                <!--              <custom-calender th:attr="email=${email}"></custom-calender>-->
                <div class="row justify-content-center gap-3 h-600">
                    <div id="calendar" class="col-lg-8 bg-white p-3 rounded fc fc-media-screen fc-direction-ltr fc-theme-standard"></div>
                    <div class="col-auto">
                        <button id="todolistPopup" class="btn border btn-facebook shadow-lg p-3 mb-5">üëàTodoList</button>
                    </div>
                    <div id="todolistContainer" class="row position-absolute col-lg-6 col-md-6 col-sm-3 fade d-none">
                        <div class="bg-white shadow-lg rounded" id="todolist">
                            <div class="row justify-content-center">
                                <h4 class="h4 p-4 col">TodoList</h4>
                                <h4 class="h4 p-4 col-auto">
                                    <button type="button" id="todolistExit" class="btn btn-danger col-auto">X</button>
                                </h4>
                            </div>
                            <form id="todoForm">
                                <label class="row justify-content-between gap-3 m-2">
                                    <input class="col col-form-label form-control" type="text" placeholder="Ìï† Ïùº ÏûÖÎ†•" name="todoTitle" id="todoTitle">
                                    <button class="btn btn-facebook col-auto" type="submit">+</button>
                                </label>
                                <label class="row justify-content-center gap-5">
                                    <input type="date" class="col-lg-4 col-sm-3 col-md-3 form-control input-group" name="startDate" id="startDate">~
                                    <input type="date" class="col-lg-4 col-sm-3 col-md-3 form-control input-group" name="endDate" id="endDate">
                                </label>
                                <hr class="border border-dark">
                            </form>
                            <ul class="nav nav-tabs" id="todoTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="all-tab"
                                            data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab"
                                            aria-controls="all" aria-selected="true">Ìï† Ïùº
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="completed-tab"
                                            data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab"
                                            aria-controls="completed" aria-selected="false">ÏôÑÎ£å Î™©Î°ù
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="pending-tab"
                                            data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab"
                                            aria-controls="pending" aria-selected="false">ÏÇ≠Ï†ú Î™©Î°ù
                                    </button>
                                </li>
                            </ul>
                            <div class="tab-content" id="todoTabsContent">
                                <div class="tab-pane fade show active" id="allTodo" role="tabpanel" aria-labelledby="all-tab">
                                    <ul class="list-group" id="todoListing"></ul>
                                </div>
                                <div class="tab-pane fade" id="completedTodo" role="tabpanel" aria-labelledby="completed-tab">
                                    <ul class="list-group" id="todoListCompleted"></ul>
                                </div>
                                <div class="tab-pane fade" id="deleteTodo" role="tabpanel" aria-labelledby="pending-tab">
                                    <ul class="list-group" id="todoListDeleted"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--                <button type="button" class="btn-facebook" data-target="#todoListModal" data-toggle="modal">+</button>-->
            </div> <!--row end -->
            <custom-todo-list></custom-todo-list>
            <!-- End of Page Wrapper -->
            <custom-setting-modal></custom-setting-modal>
            <custom-scroll-top-btn></custom-scroll-top-btn>
        </div>
    </div>
</div>


<!-- sidebar & topbar & Ïä§ÌÅ¨Î°§ Ïª¥Ìè¨ÎÑåÌä∏Ìôî -->
<script th:src="@{js/component/sidebar.js}"></script>
<script th:src="@{js/component/topbar.js}"></script>
<script th:src="@{js/component/scrollTopButton.js}"></script>
<!-- PopupComponent -->
<script th:src="@{js/component/studyCreateModal.js}"></script>
<script th:src="@{js/component/studyInfoModal.js}"></script>
<script th:src="@{js/component/userDropModal.js}"></script>
<script th:src="@{js/component/userSettingModal.js}"></script>
<script th:src="@{js/component/todoList.js}"></script>
<!-- Ï∫òÎ¶∞Îçî -->

<script>

    const email = `[[${email}]]`.replace(/"/g, '');

    // JavaScript Ìï®ÏàòÎì§
    function setupEventListeners() {
        document.getElementById("todolistPopup").addEventListener("click", (event) => this.handlePopupClick(event));
        document.getElementById("todolistExit").addEventListener("click", (event) => this.handleExitClick(event));
        document.addEventListener("click", (event) => this.handleOutsideClick(event));
        document.getElementById("todoForm").addEventListener("submit", (e) => this.submitTodo(e));
        document.getElementById("all-tab").addEventListener("click", () => this.showAllTodos());
        document.getElementById("completed-tab").addEventListener("click", () => this.showCompletedTodos());
        document.getElementById("pending-tab").addEventListener("click", () => this.showDeletedTodos());
    }

    function initializeData() {
        this.calenderJson = [];  // Ï∫òÎ¶∞Îçî Ïù¥Î≤§Ìä∏Î•º Ï†ÄÏû•Ìï† Î∞∞Ïó¥ Ï¥àÍ∏∞Ìôî

        Promise.all([
            fetchAllTodos(),
            fetchAcceptMyStudy.call(this),
            // fetchManageMyStudy.call(this)
        ]).then(() => {
            refreshCalendar.call(this); // ÏÉàÎ°úÍ≥†Ïπ® Ìï®ÏàòÎèÑ Ï†ÅÏ†àÌïú Ïª®ÌÖçÏä§Ìä∏ÏóêÏÑú Ìò∏Ï∂ú
        }).catch(error => {
            console.error('Error initializing data:', error);
        });
    }


    /**
     * Í∞ÄÏûÖÏôÑÎ£å Ïä§ÌÑ∞Îîî Î™©Î°ù
     */
    function fetchAcceptMyStudy() {
        fetch(`/api/todolists/tasks/${this.email}`, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            .then(response => response.json())
            .then(studies => {
                const acceptedStudies = studies.map(study => ({
                    title: study.studyName,
                    start: study.firstDate,
                    end: study.stEndDate,
                    backgroundColor: '#9d94ff',
                    borderColor: '#9d94ff'
                }));
                this.calenderJson.push(...acceptedStudies);
                this.refreshCalendar();
            })
            .catch(error => console.error('Error fetching accepted studies:', error));
    }

    /**
     * Î∞©Ïû•Ïù∏ Ïä§ÌÑ∞Îîî
     */
    function fetchManageMyStudy() {
        fetch(`/api/todolists/tasksManaged/${this.email}`, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            .then(response => response.json())
            .then(studies => {
                const managedStudies = studies.map(study => ({
                    title: study.studyName,
                    start: study.firstDate,
                    end: study.stEndDate,
                    backgroundColor: '#ff9d94',
                    borderColor: '#ff9d94'
                }));
                this.calenderJson.push(...managedStudies);
                this.refreshCalendar();
            })
            .catch(error => console.error('Error fetching managed studies:', error));
    }


    /**
     * Ï∫òÎ¶∞Îçî ÏÉàÎ°úÍ≥†Ïπ®
     */
    function refreshCalendar() {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: this.calenderJson
        });
        calendar.render();
    }


    // ------------------
    /**
     * Ìà¨ÎëêÎ¶¨Ïä§Ìä∏ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÌåùÏóÖ Ï∞Ω Ïù¥Î≤§Ìä∏
     * @param event
     */
    function handlePopupClick(event) {
        const todolistContainer = document.getElementById("todolistContainer");
        event.stopPropagation();
        clearTimeout(this.todolistExitTimeout);
        todolistContainer.classList.remove("fade", "d-none");
        this.todolistPopupTimeout = setTimeout(() => {
            todolistContainer.classList.add("show");
        }, 0);
    }

    /** Ìà¨ÎëêÎ¶¨Ïä§Ìä∏ xÎ≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ïù¥Î≤§Ìä∏
     * @param event
     */
    function handleExitClick(event) {
        const todolistContainer = document.getElementById("todolistContainer");
        clearTimeout(this.todolistPopupTimeout);
        this.todolistExitTimeout = setTimeout(() => {
            todolistContainer.classList.remove("show");
            todolistContainer.classList.add("fade", "d-none");
        }, 600);
    }

    /**
     * Ìà¨ÎëêÎ¶¨Ïä§Ìä∏ ÏòÅÏó≠ Ïô∏ ÌÅ¥Î¶≠ Ïãú Ïù¥Î≤§Ìä∏
     * @param event
     */
    function handleOutsideClick(event) {
        const todolistContainer = document.getElementById("todolistContainer");
        if (!todolistContainer.contains(event.target)) {
            clearTimeout(this.todolistPopupTimeout);
            this.todolistExitTimeout = setTimeout(() => {
                todolistContainer.classList.remove("show");
                todolistContainer.classList.add("fade", "d-none");
            }, 600);
        }
    }

    /**
     * Ìà¨ÎëêÎ¶¨Ïä§Ìä∏ ÏûëÏÑ±Ïãú OnClick Ïù¥Î≤§Ìä∏
     * @param e
     */
    function submitTodo(e) {
        e.preventDefault(); //ÏÉàÎ°úÍ≥†Ïπ® Î∞©ÏßÄ
        const formData = new FormData(e.target); // 'e.target'ÏùÄ Ïù¥Î≤§Ìä∏Í∞Ä Î∞úÏÉùÌïú ÌèºÏùÑ Í∞ÄÎ¶¨ÌÇµÎãàÎã§.

        // // FormData Í∞ùÏ≤¥ÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Ï∂îÏ∂úÌï©ÎãàÎã§.
        // formData.forEach((value, key) => {
        //     console.log(`${key}: ${value}`);
        // });


        // ÏΩòÏÜîÏóê Ï∂úÎ†•ÌïòÏó¨ ÌôïÏù∏
        console.log('email:',email);

        const todoTitle = formData.get('todoTitle');
        const startDate = formData.get('startDate');
        const endDate = formData.get('endDate');
        if (!todoTitle || !startDate || !endDate) {
            alert("ÎÇ¥Ïö©Í≥º ÎÇ†ÏßúÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
            return;
        } else if (new Date(startDate) > new Date(endDate)) {
            alert("ÏãúÏûë ÎÇ†ÏßúÎäî Ï¢ÖÎ£å ÎÇ†ÏßúÎ≥¥Îã§ Ïù¥ÌõÑÏùº Ïàò ÏóÜÏäµÎãàÎã§.");
            return;
        }

        alert("Ìï† Ïùº Î¶¨Ïä§Ìä∏Ïóê ÏóÖÎ°úÎìú ÎêòÏóàÏäµÎãàÎã§.");

        fetch('/api/todolists', {
            method: 'POST',
            headers: {'Content-Type': "application/json"},
            body: JSON.stringify({
                todolistContent: todoTitle,
                todoStartDate: startDate,
                todoEndDate: endDate,
                memberEmail: email
            })
        })
            .then(response => response.json())
            .then(data => {
                this.addTodoItemToList(document.getElementById('todoListing'), data);
                document.getElementById('todoTitle').value = '';
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';

                this.fetchAllTodos();
            })
            .catch(error => {
                console.error("Error:", error);
            });
    }

    /**
     * ÏûÖÎ†´Îêú Ìà¨Îëê ÌôîÎ©¥ Ï∂úÎ†•
     * @param listElement
     * @param todo
     */
    function addTodoItemToList(listElement, todo) {
        console.log("addTOdoItemToList")
        console.log(listElement)
        console.log(todo)
        console.log(todo.to_no)
        const listItem = document.createElement('li');
        listItem.className = 'justify-content-between m-1 row shadow p-3 mb-2 bg-body rounded';
        listItem.setAttribute('id', `todo-${todo.to_no}`);
        listItem.innerHTML = `
            <div class="col">
                <strong class="row">${todo.todolist_content}</strong>
                <div class="row">${todo.todo_start_date} ~ ${todo.todo_end_date}</div>
            </div>
            <div class="col-auto">
                <button id="todoComplete-${todo.to_no}" class="col btn btn-info mb-1" name="${todo.to_no}">V</button>
                <button id="todoDelete-${todo.to_no}" class="col btn btn-danger mt-1" name="${todo.to_no}">X</button>
            </div>
        `;
        listElement.appendChild(listItem);

        listItem.querySelector(`#todoComplete-${todo.to_no}`).addEventListener('click', () => this.isCompletedTrue(todo.to_no));
        listItem.querySelector(`#todoDelete-${todo.to_no}`).addEventListener('click', () => this.isDeletedTrue(todo.to_no));
    }

    /**
     * Ìï†Ïùº ÏôÑÎ£å Ï≤òÎ¶¨
     * @param toNo
     */
    function isCompletedTrue(toNo) {
        fetch(`/api/todolists/completed/${toNo}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'}
        })
            .then(() => {
                alert('Todo marked as completed!');
                const todoItem = document.querySelector(`#todo-${toNo}`);
                console.log(toNo)
                if (todoItem) {
                    document.getElementById('todoListCompleted').appendChild(todoItem);
                }
                this.fetchAllTodos();
            })
            .catch(error => console.error("Error marking todo as completed:", error));
    }

    /**
     * Ìï†Ïùº ÏÇ≠Ï†ú Ï≤òÎ¶¨
     * @param toNo
     */
    function isDeletedTrue(toNo) {
        fetch(`/api/todolists/delete/${toNo}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'}
        })
            .then(() => {
                alert('Todo marked as deleted!');
                const todoItem = document.querySelector(`#todo-${toNo}`);
                if (todoItem) {
                    document.getElementById('todoListDeleted').appendChild(todoItem);
                }
                this.fetchAllTodos();
            })
            .catch(error => console.error("Error marking todo as deleted:", error));
    }

    /**
     *
     */
    function fetchAllTodos() {
        console.log("featchTodos")
        fetch(`/api/todolists`, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            .then(response => response.json())
            .then(todos => {
                const todoList = document.getElementById('todoListing');
                todoList.innerHTML = '';
                todos.forEach(todo => {
                    console.log(todo)
                    this.addTodoItemToList(todoList, todo);
                });
            })
            .catch(error => {
                console.error("Error fetching todos:", error);
            });
    }

    function showAllTodos() {
        this.fetchAllTodos();
    }

    function showCompletedTodos() {
        console.log("showcompletedTOdos")

        fetch(`/api/todolists/completed`, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            .then(response => response.json())
            .then(todos => {
                const todoListCompleted = document.getElementById('todoListCompleted');
                todoListCompleted.innerHTML = '';
                todos.forEach(todo => {
                    this.addTodoItemToList(todoListCompleted, todo);
                });
            })
            .catch(error => console.error('Error fetching completed todos:', error));
    }

    function showDeletedTodos() {
        fetch(`/api/todolists/deleted`, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            .then(response => response.json())
            .then(todos => {
                const todoListDeleted = document.getElementById('todoListDeleted');
                todoListDeleted.innerHTML = '';
                todos.forEach(todo => {
                    this.addTodoItemToList(todoListDeleted, todo);
                });
            })
            .catch(error => console.error('Error fetching deleted todos:', error));
    }

    document.addEventListener("DOMContentLoaded", function() {
        setupEventListeners();
        initializeData();
    });
</script>

<!-- Î∂ÄÌä∏Ïä§Ìä∏Îû© JS (ÌåùÏóÖÏùÑ ÏúÑÌï¥ ÌïÑÏöî) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- Bootstrap core JavaScript-->
<script th:src="@{vendor/jquery/jquery.min.js}"></script>

<!-- Core plugin JavaScript-->
<script th:src="@{vendor/jquery-easing/jquery.easing.min.js}"></script>
<!-- Custom scripts for all pages-->
<script th:src="@{js/sb-admin-2.min.js}"></script>

</body>
</html>